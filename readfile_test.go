package main

import (
	"bytes"
	"encoding/csv"
	"strings"
	"testing"
)

func TestReadFileReader(t *testing.T) {
	rf := strings.NewReader(`"Date","P. O. #","Location","Processor/Vendor","Item Num","Qty","Price"
"Week of Sep 23, 18",,,,,,
"09/24/2018","9856","HEN","295","FZNINS",18323.58,"$ 2.8389"
"09/24/2018","9856","HEN","295","FZNINS",13935.5,"$ 2.8389"
"09/24/2018","9856","HEN","295","FZNINS",6337.39,"$ 2.8389"
"09/24/2018","9680","DSP","144","FSHINS",39334,"$ 2.8712"
"09/24/2018","AZJ058","OTP","181","223NZ",39494.08,"$ 8.8066"
"09/24/2018","9848","HEN","295","BEEF95",42000,"$ 2.1626"
"09/24/2018","9849","HEN","628","BEEF95",21000,"$ 2.1800"
"09/24/2018","9849","HEN","628","BEEF95",21000,"$ 2.1800"
"09/24/2018","9850","HEN","628","BEEF95",20880,"$ 2.1800"
"09/24/2018","9850","HEN","628","BEEF95",21000,"$ 2.1800"
"09/24/2018","9851","HEN","508","BEEF95",42000,"$ 2.1850"
"09/24/2018","9877","DSP","507","FSHINS",22000,"$ 2.8240"
"09/24/2018","9884","HEN","509","BEEFHEARTS",22800,"$ .7300"
"09/24/2018","9884","HEN","509","BEEF65",19200,"$ 1.0200"
"09/24/2018","9885","HEN","1015","BEEF65",39000,"$ .9000"
"09/24/2018","9886","HEN","1015","BEEF65",37580,"$ .9000"
"09/24/2018","9887","HEN","1015","BEEF65",650,"$ .9000"
"09/24/2018","9888","HEN","212","BEEFHEARTS",40040,"$ .5800"
"09/24/2018","9889","HEN","212","BEEF50",40950,"$ .5800"
"09/25/2018","9648","DSP","151","FSHINS",42500,"$ 2.8155"
"09/26/2018","9655","DSP","507","FSHINS",42000,"$ 2.8240"
"09/27/2018","9883","DSP","151","FSHINS",42000,"$ 2.8155 + frefight"
"09/28/2018","9681","DSP","144","FSHINS",42000,"$ 2.8712"
"09/29/2018","9701","DSP","509","FSHINS",42000,"$ 2.8412"
"Week of Sep 23, 18",,,,,,
`)
	wf := &bytes.Buffer{}
	want := `
H,9856,295,09/24/2018,HEN,HEN
R,FZNINS,18323.58,2.8389
H,9856,295,09/24/2018,HEN,HEN
R,FZNINS,13935.5,2.8389
H,9856,295,09/24/2018,HEN,HEN
R,FZNINS,6337.39,2.8389
H,9680,144,09/24/2018,DSP,DSP
R,FSHINS,39334,2.8712
H,AZJ058,181,09/24/2018,OTP,OTP
R,223NZ,39494.08,8.8066
H,9848,295,09/24/2018,HEN,HEN
R,BEEF95,42000,2.1626
H,9849,628,09/24/2018,HEN,HEN
R,BEEF95,21000,2.1800
H,9849,628,09/24/2018,HEN,HEN
R,BEEF95,21000,2.1800
H,9850,628,09/24/2018,HEN,HEN
R,BEEF95,20880,2.1800
H,9850,628,09/24/2018,HEN,HEN
R,BEEF95,21000,2.1800
H,9851,508,09/24/2018,HEN,HEN
R,BEEF95,42000,2.1850
H,9877,507,09/24/2018,DSP,DSP
R,FSHINS,22000,2.8240
H,9884,509,09/24/2018,HEN,HEN
R,BEEFHEARTS,22800,.7300
H,9884,509,09/24/2018,HEN,HEN
R,BEEF65,19200,1.0200
H,9885,1015,09/24/2018,HEN,HEN
R,BEEF65,39000,.9000
H,9886,1015,09/24/2018,HEN,HEN
R,BEEF65,37580,.9000
H,9887,1015,09/24/2018,HEN,HEN
R,BEEF65,650,.9000
H,9888,212,09/24/2018,HEN,HEN
R,BEEFHEARTS,40040,.5800
H,9889,212,09/24/2018,HEN,HEN
R,BEEF50,40950,.5800
H,9648,151,09/25/2018,DSP,DSP
R,FSHINS,42500,2.8155
H,9655,507,09/26/2018,DSP,DSP
R,FSHINS,42000,2.8240
H,9883,151,09/27/2018,DSP,DSP
R,FSHINS,42000,2.8155 + frefight
H,9681,144,09/28/2018,DSP,DSP
R,FSHINS,42000,2.8712
H,9701,509,09/29/2018,DSP,DSP
R,FSHINS,42000,2.8412
	`

	w := csv.NewWriter(wf)
	err := readFileReader(w, rf)
	if err != nil {
		t.Fatal(err)
	}
	got := strings.TrimSpace(wf.String())
	want = strings.TrimSpace(want)
	if want != got {
		t.Fatalf("incorrect result, got:\n%s\n", got)
	}
}
